<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-icon/iron-icon.html">
<link rel="import" href="brainy-table-icons.html">

<dom-module id="brainy-table-column-sort">
  <template>
    <style>
      :host {
        display: block;
        margin: 4px;
      }

      :host([hidden]) {
        display: none;
      }

      :host .wrapper {
        position: relative;
        left: -24px;
      }

      #icon {
        width: 16px;
        height: 16px;
        fill: rgba(0, 0, 0, 0.87);
        transition: transform 0.25s;
      }

      #icon:not([direction]) {
        fill: rgba(0, 0, 0, 0.38);
      }

      #icon:hover {
        fill: var(--default-primary-color);
        cursor: pointer;
      }

      #icon[direction='desc'] {
        transform: rotate(-180deg);
      }

      #icon[hidden] {
        display: none;
      }

      .order {
        font-size: 9px;
        font-weight: bold;
        position: absolute;
        right: 0;
        bottom: -4px;
      }
    </style>

    <div class="wrapper">
      <iron-icon
        id="icon"
        on-tap="_sort"
        icon="brainy-table:arrow-upward"
        direction$="[[direction]]"
      ></iron-icon>
      <div class="order">[[order]]</div>
    </div>
  </template>
  <script>
    (function() {
      'use strict';

      Polymer({
        is: 'brainy-table-column-sort',

        properties: {
          direction: {
            type: String,
            reflectToAttribute: true,
            notify: true
          },
          path: String,
          order: {
            type: Number,
            computed: '_order(path, sortOrder, sortOrder.length)'
          },
          sortOrder: Array
        },

        observers: [
          '_sortOrderChanged(sortOrder.*)'
        ],

        _order: function(path, sortOrder, length) {
          if (length <= 1) {
            return '';
          }

          for (var i = 0; i < length; i++) {
            if (sortOrder[i].path === path) {
              return i + 1;
            }
          }
        },

        _sortOrderChanged: function(sortOrder) {
          // TODO: if sortOrder for this column has been removed from outside, direction is not updated.
          if (sortOrder.base) {
            sortOrder.base.forEach(function(sort) {
              if (sort.path === this.path) {
                this.direction = sort.direction;
                return;
              }
            }.bind(this));
          }
        },

        _sort: function() {
          switch (this.direction) {
            case 'asc':
              this.direction = 'desc';
              break;

            case 'desc':
              this.direction = null;
              break;

            default:
              this.direction = 'asc';
              break;
          }

          this.fire('sort-direction-changed', {
            path: this.path,
            direction: this.direction
          });
        }
      });
    })();
  </script>
</dom-module>
